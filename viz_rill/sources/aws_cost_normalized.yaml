# AWS CUR Source - Normalized
# Auto-generated source for AWS Cost and Usage Report data
# Inspired by: https://github.com/rilldata/aws-cur-wizard (now integrated as cur-wizard)

type: source

connector: duckdb

sql: |
  SELECT
    -- Extract date from identity_time_interval (format: "2025-11-01T00:00:00Z/2025-12-01T00:00:00Z")
    CAST(SPLIT_PART(identity_time_interval, 'T', 1) AS DATE) AS date,

    -- Bill information
    bill_bill_type,
    bill_billing_entity,
    bill_payer_account_id,
    bill_payer_account_name,

    -- Line item details (key cost columns)
    line_item_blended_cost,
    line_item_unblended_cost,
    line_item_currency_code,
    line_item_line_item_description,
    line_item_line_item_type,
    line_item_product_code,
    line_item_usage_account_id,
    line_item_usage_account_name,
    line_item_usage_amount,
    line_item_usage_type,
    line_item_operation,
    line_item_blended_rate,
    line_item_unblended_rate,

    -- Product information
    COALESCE(product_servicecode, line_item_product_code, 'Unknown') AS product_product_name,
    product_servicecode AS product_servicename,
    product_product_family,
    product_region_code,
    product_location,
    product_usagetype,
    product_operation,

    -- Pricing
    pricing_public_on_demand_cost,
    pricing_public_on_demand_rate,
    pricing_term,
    pricing_unit,

    -- Reservations (for effective cost calculation)
    COALESCE(reservation_amortized_upfront_cost_for_usage, 0) AS reservation_amortized_upfront_cost_for_usage,
    COALESCE(reservation_effective_cost, 0) AS reservation_effective_cost,
    COALESCE(reservation_recurring_fee_for_usage, 0) AS reservation_recurring_fee_for_usage,
    COALESCE(reservation_unused_recurring_fee, 0) AS reservation_unused_recurring_fee,

    -- Savings Plans (for effective cost calculation)
    COALESCE(savings_plan_savings_plan_effective_cost, 0) AS savings_plan_savings_plan_effective_cost

  FROM read_parquet('data/aws_costs/cur_export_test_00001/*.parquet', union_by_name=true)
  WHERE identity_time_interval IS NOT NULL
