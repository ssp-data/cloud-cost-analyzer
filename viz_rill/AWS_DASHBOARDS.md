# AWS Advanced Dashboards Integration

This document explains the aws-cur-wizard integration and how to use the advanced AWS analytics features.

## What We Added

We've integrated the sophisticated AWS cost analysis capabilities from [aws-cur-wizard](https://github.com/rilldata/aws-cur-wizard) into this project. This gives you:

### 1. **Advanced AWS Metrics**

Your AWS data now includes:
- **Effective Cost** - True cost after RI/SP amortization
- **RI Utilization** - Track unused Reserved Instance capacity
- **Savings Tracking** - How much you save vs. on-demand pricing
- **Unit Economics** - Cost per usage unit ($/GB, $/hour, etc.)
- **Marketplace Isolation** - Separate view of 3rd-party charges

### 2. **Multiple Dashboard Views**

| Dashboard | Purpose | File |
|-----------|---------|------|
| **AWS Cost Analytics** | Overview with RI/SP tracking, regional breakdowns, efficiency metrics | `dashboards/aws_overview.yaml` |
| **AWS Cost Explorer** | Interactive drill-down across all dimensions | `dashboards/aws_explore.yaml` |
| **AWS Product Deep Dive** | Leaderboards for products, services, usage types | `dashboards/aws_product_insights.yaml` |
| **Cloud Cost Analytics** | Multi-cloud view (AWS + GCP + Stripe) | `dashboards/cloud_cost_explore.yaml` |

### 3. **Dynamic Dashboard Generation** (Advanced)

The aws-cur-wizard scripts can automatically generate custom dashboards based on your data's dimensions:

```bash
make aws-dashboards
```

This will:
1. Normalize your AWS CUR data (flatten any nested structures)
2. Analyze your data's schema
3. Generate tailored dashboards based on available dimensions
4. Create dynamic canvases for product/resource dimensions

## Quick Start

### View Existing Dashboards

```bash
make serve
# or
cd viz_rill && rill start
```

Then navigate to:
- **AWS Cost Analytics** - Your main AWS dashboard
- **AWS Cost Explorer** - For ad-hoc analysis
- **AWS Product Deep Dive** - For detailed breakdowns

### Generate Dynamic Dashboards (Optional)

If you want to regenerate dashboards or create custom dimension-specific views:

```bash
# Full workflow
make aws-dashboards

# Or step-by-step:
make aws-normalize              # Flatten & normalize AWS data
make aws-generate-dashboards    # Generate Rill YAML files
make serve                      # View in browser
```

### List Available Cost Columns

```bash
make aws-list-cost-cols
```

Output:
```
• line_item_blended_cost
• line_item_unblended_cost
• line_item_usage_amount
• pricing_public_on_demand_cost
• reservation_effective_cost
• savings_plan_savings_plan_effective_cost
• ...
```

## How It Works

### Data Flow

```
AWS CUR Export (S3)
    ↓
dlt Pipeline (pipelines/aws_pipeline.py)
    ↓
Parquet Files (viz_rill/data/aws_costs/)
    ↓
Normalization (scripts/normalize.py)
    ↓
normalized_aws.parquet
    ↓
Rill Sources & Metrics
    ↓
Dashboards (static & dynamic)
```

### Static vs. Dynamic Dashboards

**Static Dashboards** (what we created manually):
- `aws_overview.yaml` - Pre-configured AWS analytics canvas
- `aws_explore.yaml` - Interactive explorer
- `aws_product_insights.yaml` - Product dimension deep dive

**Dynamic Dashboards** (generated by aws-cur-wizard scripts):
- Automatically created based on your data's schema
- Adapts to changes in AWS CUR structure
- Uses intelligent chart selection algorithm
- Creates dimension-specific canvases (e.g., one for products, one for regions)

### The Dimension Chart Selector Algorithm

From `scripts/utils/dimension_chart_selector.py`:

1. **Candidate Discovery** - Finds columns matching prefixes (e.g., `product_*`, `line_item_*`)
2. **Qualification** - Only includes dimensions with:
   - ≥5% cost coverage
   - >2 distinct values
3. **Dominant Slice Peeling** - Identifies values representing ≥70% of spend
4. **Chart Selection** - Chooses chart type based on cardinality:
   - ≤10 values → Pie chart
   - 11-40 values → Bar chart
   - >40 values → Leaderboard

## Customization

### Change Cost Column

Edit `viz_rill/.env`:
```bash
COST_COL=line_item_effective_cost  # Use effective cost instead
```

Then regenerate:
```bash
make aws-dashboards
```

### Add Dimension Prefixes

To create canvases for specific dimension groups:

```bash
# In viz_rill/.env
DIM_PREFIXES=product_,line_item_,resource_tags_

# Then regenerate
make aws-dashboards
```

### Custom Timeseries Column

If your data uses a different date column:

```bash
# In viz_rill/.env
TIMESERIES_COL=line_item_usage_start_date
```

## Files Added

```
viz_rill/
├── scripts/
│   ├── normalize.py                    # Normalize & flatten AWS data
│   ├── generate_rill_yaml.py           # CLI for dashboard generation
│   ├── rill_project_generator.py       # Core generation logic
│   ├── generate_aws_dashboards.py      # Our custom generator
│   ├── normalize_aws.py                # Our custom normalizer
│   └── utils/
│       └── dimension_chart_selector.py # Chart selection algorithm
├── templates/
│   ├── overview_canvas_template.yml.j2  # Overview dashboard template
│   ├── map_canvas_template.yml.j2       # Dynamic dimension canvases
│   ├── metrics_template.yml.j2          # Metrics view template
│   ├── source_template.yml.j2           # Source template
│   └── explore_template.yml.j2          # Explore template
├── sources/
│   └── aws_cost_normalized.yaml         # AWS CUR source (static)
├── metrics/
│   └── aws_cost_metrics.yaml            # AWS metrics (static)
├── dashboards/
│   ├── aws_overview.yaml                # Main AWS dashboard (static)
│   ├── aws_explore.yaml                 # Explorer (static)
│   └── aws_product_insights.yaml        # Product analysis (static)
└── .env.example                          # Configuration template
```

## Comparison: Your Data vs. aws-cur-wizard

### Data Structure: **100% Compatible** ✅

Your AWS CUR data from dlt has the **exact same schema** as aws-cur-wizard expects:
- All `line_item_*` columns present
- All `product_*` columns present
- All `reservation_*` and `savings_plan_*` columns present
- Same column naming conventions

### Differences:

| Aspect | aws-cur-wizard | Your Project |
|--------|----------------|--------------|
| **Data Source** | Manual S3 export | dlt pipeline (automated) |
| **Normalization** | Python script flattens MAP columns | dlt already flattens (no MAPs found) |
| **Dashboard Generation** | 100% dynamic (Jinja2 templates) | Hybrid (static + optional dynamic) |
| **Multi-Cloud** | AWS only | AWS + GCP + Stripe |
| **Resource Tags** | Yes (if exported with tags) | Not yet (can add later) |

### Why Use Both Approaches?

**Static Dashboards** (what we created):
- ✅ Fast to load (no generation step)
- ✅ Version controlled (see changes in git)
- ✅ Customized for your specific use cases
- ✅ Multi-cloud support

**Dynamic Generation** (aws-cur-wizard):
- ✅ Adapts to schema changes automatically
- ✅ Handles resource tags elegantly
- ✅ Follows AWS best practices
- ✅ Creates dimension-specific views

**Our Recommendation**: Use **both**!
- Keep the static dashboards for day-to-day use
- Use dynamic generation when you add resource tags or need custom views

## Next Steps

### 1. View Your Dashboards

```bash
make serve
```

Browse to http://localhost:9009 and explore:
- AWS Cost Analytics
- AWS Cost Explorer
- AWS Product Deep Dive

### 2. (Optional) Generate Dynamic Dashboards

```bash
make aws-dashboards
```

This creates additional dimension-specific canvases.

### 3. Enable Resource Tags (Future)

When you enable resource tags in your AWS CUR export:

1. Run the pipeline: `make run-aws`
2. Regenerate dashboards: `make aws-dashboards --dim-prefixes "resource_tags_,product_"`
3. View tag-specific canvases in Rill

## Troubleshooting

### "No parquet files found"

Make sure you've run the AWS pipeline first:
```bash
make run-aws
```

### "Cost column not found"

List available columns:
```bash
make aws-list-cost-cols
```

Then update `.env` with a valid column.

### Dashboards not showing data

Check your date range - the default is last 12 months (`P12M`). Your data might be older or newer.

## Credits

This integration is based on the excellent work by the Rill team:
- **[aws-cur-wizard](https://github.com/rilldata/aws-cur-wizard)** - Original project
- **[Rill Data](https://www.rilldata.com/)** - For the amazing analytics platform

Special thanks for open-sourcing these patterns!

## License

The aws-cur-wizard components (templates, scripts, algorithms) are under Apache 2.0 License.
See file headers for attribution details.
